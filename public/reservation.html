<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservation</title>
    <link rel="stylesheet" href="reservation.css">
</head>
<body>
    <header class="head-bar">
        <nav class="navigation-bar">
          <ul>
            <li><a href="index2.html">Find your Cruise</a></li>
            <li><a href="index2.html">Destinations</a></li>
            <li><a href="index2.html">Cruise Lines</a></li>
            <li><a href="index2.html">Ship</a></li>
            <li><a href="index2.html">Ports</a></li>
            <li><a href="index2.html">Cruise Guides</a></li>
          </ul>
        </nav>
      </header>

    <div class="reservation-form">

        <h3>Reservation Form:</h3>
        <label for="destination">Destination:</label>
        <div class="select1">
            <select id="destination" name="destinations">
                <option value="" disabled selected>Destinations</option>
                <option value="Siargao Island">Siargao Island</option>
                <option value="Camiguin">Camiguin</option>
                <option value="Ozamis">Ozamis</option>
                <option value="Boracay">Boracay</option>
                <option value="Zamboanga">Zamboanga</option>
            </select>
            <div class="select1_arrow"></div>
        </div>

        <label for="sailingDate">Sailing Date:</label>
        <div class="select2">
            <select id="sailingDate" name="sailingDates">
                <option value="" disabled selected>Sailing Dates</option>
                <option value="01/05/2024">01/05/2024</option>
                <option value="02/03/2024">02/03/2024</option>
                <option value="03/09/2024">03/09/2024</option>
                <option value="04/13/2024">04/13/2024</option>
                <option value="05/24/2024">05/24/2024</option>
            </select>
            <div class="select2_arrow"></div>
        </div>

        <label for="cruise">Cruise:</label>
        <div class="select3">
            <select id="cruise" name="cruiseLines">
                <option value="" disabled selected>All Cruise</option>
                <option value="2GO">2GO</option>
                <option value="United Philippines Lines Inc">United Philippines Lines Inc</option>
                <option value="OSM Maritime Services Inc">OSM Maritime Services Inc</option>
                <option value="SSM Maritime Services Inc">SSM Maritime Services Inc</option>
                <option value="Singa Ship Management Phils Inc">Singa Ship Management Phils Inc</option>
            </select>
            <div class="select3_arrow"></div>
        </div>

        <label for="port">Port:</label>
        <div class="select4">
            <select id="port" name="port">
                <option value="" disabled selected>Port</option>
                <option value="Balingoan">Balingoan</option>
                <option value="Cagayan de Oro">Cagayan de Oro</option>
                <option value="Butuan">Butuan</option>
                <option value="Dapitan">Dapitan</option>
                <option value="Dipolog">Dipolog</option>
            </select>
            <div class="select4_arrow"></div>
        </div>

        <button class="reservationButton" id="reserveNow">Reserve Now</button>

        <!-- Ticket display -->
        <div id="ticket" class="hidden">
            <h3>Ticket Details:</h3>
            <p class="ticket-info" hidden id="ticketId">${ticketDetails._id}</p>
            <p class="ticket-info">Name: <span id="ticketName"></span></p>
            <p class="ticket-info">Email: <span id="ticketEmail"></span></p>
            <p class="ticket-info">Contact Information: <span id="ticketPhoneNum"></span></p>
            <p class="ticket-info">Destination: <span id="ticketDestination"></span></p>
            <p class="ticket-info">Sailing Date: <span id="ticketSailingDate"></span></p>
            <p class="ticket-info">Cruise: <span id="ticketCruise"></span></p>
            <p class="ticket-info">Port: <span id="ticketPort"></span></p>
            <p class="ticket-info">Departure Schedule: <span id="ticketDepartureDate"></span></p>
            <p class="ticket-info">Seat Number: <span id="ticketSeatNumber"></span></p>

          <button class="deleteButton" id="deleteTicket">Delete Ticket</button>
        </div>
        
    </div>
    <footer>
        <hr />
        <p>&copy; Beyond The Sea, All rights reserved.</p>
    </footer>
    <script>
        async function reserveNow() {
          try {
            const destination = document.getElementById("destination").value;
            const sailingDate = document.getElementById("sailingDate").value;
            const cruise = document.getElementById("cruise").value;
            const port = document.getElementById("port").value;

            if (destination === "" || sailingDate === "" || cruise === "" || port === "") {
              alert("Please select values for all options.");
              return;
            }

            // Disable the button to prevent multiple submissions
            document.getElementById("reserveNow").disabled = true;

            const response = await fetch('/reserve-now', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ destination, sailingDate, cruise, port }),
            });

            const responseData = await response.json();

            if (response.ok && responseData && responseData.ticketDetails) {
              const ticketDetails = responseData.ticketDetails;
              displayTicketDetails(ticketDetails);
              alert('Reservation successful. Ticket details stored.');
            } else if (responseData.error === 'User already has an active ticket') {
              // Display a custom alert for users with active tickets
              alert('You already have an active ticket. Please revoke it before making a new reservation.');
              return;
            } else {
              console.error('Error during reservation:', responseData?.error || 'Unknown error');
              alert('Error processing reservation. Please try again.');
              return;
            }
          } catch (error) {
            console.error('Error during reservation:', error);
            alert(`Internal Server Error: ${error.message}`);
          }
        }   

        document.getElementById("reserveNow").addEventListener("click", reserveNow);

        function generateSeatNumber() {
          // Generate a random seat number between 1 and 5000
          return Math.floor(Math.random() * 3000) + 1;
        }

        function calculateDepartureDate(selectedSailingDate) {
            // Parse the selected sailing date
            const sailingDate = new Date(selectedSailingDate);
          
            // Calculate the departure date with a 3-day gap
            const departureDate = new Date(sailingDate);
            departureDate.setDate(sailingDate.getDate() + 3);
          
            // Format the departure date as MM/DD/YY
            const formattedDepartureDate = `${departureDate.getMonth() + 1}/${departureDate.getDate()}/${departureDate.getFullYear()}`;
          
            return formattedDepartureDate;
          }

        function displayTicketDetails(ticketDetails) {
            const ticketElement = document.getElementById("ticket");
            const ticketName = document.getElementById("ticketName");
            const ticketEmail = document.getElementById("ticketEmail");
            const ticketPhoneNum = document.getElementById("ticketPhoneNum");
            const ticketDestination = document.getElementById("ticketDestination");
            const ticketSailingDate = document.getElementById("ticketSailingDate");
            const ticketCruise = document.getElementById("ticketCruise");
            const ticketPort = document.getElementById("ticketPort");
            const ticketDepartureDate = document.getElementById("ticketDepartureDate");
            const ticketSeatNumber = document.getElementById("ticketSeatNumber");
    
            // Update user details
            ticketName.innerText = `${ticketDetails.firstname} ${ticketDetails.lastname}`;
            ticketEmail.innerText = ticketDetails.email;
            ticketPhoneNum.innerText = ticketDetails.phoneNum;

    
            // Update ticket details
            ticketDestination.innerText = ticketDetails.destination;
            ticketSailingDate.innerText = ticketDetails.sailingDate;
            ticketCruise.innerText = ticketDetails.cruise;
            ticketPort.innerText = ticketDetails.port;
            ticketDepartureDate.innerText = ticketDetails.departureDate;
            ticketSeatNumber.innerText = ticketDetails.seatNumber;
    
            // Show the ticket element
            ticketElement.classList.remove("hidden");
        }

        // Add this function to fetch and display ticket details on page load
        async function displayTicketOnLoad() {
          try {
            // Fetch ticket details from the server
            const response = await fetch('/get-ticket-details');
            const ticketDetails = await response.json();

            if (response.ok && ticketDetails) {
              // Display ticket details on the page
              displayTicketDetails(ticketDetails);
            } else {
              console.error('Error fetching ticket details:', ticketDetails?.error || 'Unknown error');
              // Handle the error as needed
            }
          } catch (error) {
            console.error('Error fetching ticket details:', error);
            // Handle the error as needed
          }
        }

        // Call the displayTicketOnLoad function when the page loads
        window.addEventListener('load', displayTicketOnLoad);

        async function deleteTicket(ticketsCollection, userEmail, ticketId) {
          try {
            // Update this part to communicate with MongoDB and delete the ticket

            const deleteResult = await ticketsCollection.deleteOne({
              email: userEmail,
              revoked: false
            });
        
            if (deleteResult.deletedCount !== 1) {
              console.error('Error deleting ticket:', deleteResult);
              return { success: false, error: 'Error deleting ticket' };
            }
        
            return { success: true }; // Return success without updated ticket information
          } catch (error) {
            console.error('Error deleting ticket:', error);
            return { success: false, error: 'Internal Server Error' };
          }
        }        
        
        // An event listener to the "Delete Ticket" button
        document.getElementById("deleteTicket").addEventListener("click", async () => {
          const ticketIdElement = document.getElementById("ticketId");
          const ticketId = ticketIdElement.innerText;
          const userEmail = document.getElementById("ticketEmail").innerText;
          const result = await deleteTicket(ticketsCollection, userEmail, ticketId);
          // Handle the result as needed
        });        

    </script>    
</body>
</html>
